<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¼êµ­ì‹œëŒ€ ì „ì„±ê¸° ì¸í„°ë™í‹°ë¸Œ í•™ìŠµ</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            color: #333;
            overflow-x: hidden;
        }

        /* ===== ì‹œì‘ í™”ë©´ ===== */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .start-screen.hidden {
            display: none;
        }
        .start-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .start-box h1 { margin-bottom: 30px; color: #444; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .input-group input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px;
            font-size: 16px;
        }
        .start-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        .start-btn:hover { background: #5567d9; }

        /* ===== ë©”ì¸ ë ˆì´ì•„ì›ƒ (ì¢Œìš° êµ¬ì¡°) ===== */
        .container {
            display: flex;
            width: 100%;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }

        .left-panel {
            flex: 1.2;
            padding: 20px;
            background: #fff;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .right-panel {
            flex: 0.8;
            padding: 20px;
            background: #f8fafc;
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .container { flex-direction: column; height: auto; }
            .left-panel, .right-panel { flex: none; width: 100%; border-right: none; }
            .left-panel { height: 500px; border-bottom: 1px solid #ddd; }
        }

        header { text-align: center; margin-bottom: 20px; width: 100%; }

        .map-container {
            position: relative;
            width: 400px;
            height: 520px;
            background-image: url('https://gtmc-history.github.io/three-kingdoms-map/map_base.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 0 auto;
        }

        .map-point {
            position: absolute;
            width: 20px; height: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255,255,255,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
        }

        .era-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .era-btn {
            padding: 10px 20px; border: none; border-radius: 30px; cursor: pointer;
            font-weight: bold; transition: all 0.3s; background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .era-btn.active { color: white; transform: translateY(-2px); }
        .btn-baekje.active { background-color: #e67e22; }
        .btn-goguryeo.active { background-color: #c0392b; }
        .btn-silla.active { background-color: #2980b9; }

        .mission-section { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .mission-card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid #ddd;
        }
        .mission-card.completed { border-left-color: #27ae60; background-color: #f0fff4; }
        
        .mission-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .mission-badge { background: #eee; padding: 4px 10px; border-radius: 20px; font-size: 12px; }

        .mission-input-group { display: flex; gap: 10px; margin-top: 15px; }
        .mission-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .check-btn { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }

        .summary-container { margin-top: 30px; text-align: center; display: flex; flex-direction: column; gap: 10px; }
        .btn-group-final { display: flex; justify-content: center; gap: 10px; }
        .final-btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; flex: 1; }
        .summary-btn { background: #667eea; color: white; }
        .submit-btn { background: #27ae60; color: white; }

        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        #modal.visible { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="startScreen" class="start-screen">
        <div class="start-box">
            <h1>ğŸ›¡ï¸ ì‚¼êµ­ì‹œëŒ€ íƒí—˜</h1>
            <p>ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  í•™ìŠµì„ ì‹œì‘í•˜ì„¸ìš”</p>
            <div class="input-group">
                <label>ë°˜</label>
                <input type="text" id="classNum" placeholder="ì˜ˆ: 1ë°˜">
            </div>
            <div class="input-group">
                <label>í•™ë²ˆ</label>
                <input type="text" id="studentId" placeholder="ì˜ˆ: 15ë²ˆ">
            </div>
            <div class="input-group">
                <label>ì´ë¦„</label>
                <input type="text" id="studentName" placeholder="í™ê¸¸ë™">
            </div>
            <button class="start-btn" onclick="startLearning()">ëª¨í—˜ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="container">
        <div class="left-panel">
            <header>
                <h1>ì‚¼êµ­ì‹œëŒ€ ì „ì„±ê¸° ì§€ë„ í•™ìŠµ</h1>
                <p>ì§€ë„ì˜ í¬ì¸íŠ¸ë¥¼ í´ë¦­í•˜ì—¬ ì§€ì—­ëª…ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            </header>
            <div class="era-selector">
                <button class="era-btn btn-baekje active" onclick="changeEra('baekje')">4ì„¸ê¸° ë°±ì œ</button>
                <button class="era-btn btn-goguryeo" onclick="changeEra('goguryeo')">5ì„¸ê¸° ê³ êµ¬ë ¤</button>
                <button class="era-btn btn-silla" onclick="changeEra('silla')">6ì„¸ê¸° ì‹ ë¼</button>
            </div>
            <div class="map-container" id="mapContainer"></div>
        </div>

        <div class="right-panel">
            <div class="mission-section" id="missionSection"></div>
            <div class="summary-container">
                <div class="btn-group-final">
                    <button class="final-btn summary-btn" onclick="showSummary()">ğŸ“œ í•™ìŠµ ê²°ê³¼ ì •ë¦¬í•˜ê¸°</button>
                    <button class="final-btn submit-btn" onclick="submitAllData()">ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì œì¶œí•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">ì§€ì—­ ì •ë³´</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // !ì¤‘ìš”: ë³¸ì¸ì˜ Google Apps Script ë°°í¬ URLë¡œ êµì²´í•˜ì„¸ìš”.
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyWTXav8l5fhQSwZGxqoQYAexzIgyIq4GrHCxlB9-FSF2tHNr9y2OJIZ0WR0fN7lq4p/exec'; 

        let studentInfo = { classNum: '', studentId: '', studentName: '' };
        let currentEra = 'baekje';
        let solvedMissions = {};
        let hintCount = 0; // íŒíŠ¸ ì‚¬ìš© íšŸìˆ˜ ì¶”ì 

        const pointsData = {
            'baekje': [
                { id: 1, x: '42%', y: '45%', title: 'í•œì„±(ì„œìš¸)', content: 'ë°±ì œì˜ ì²« ìˆ˜ë„.', icon: 'ğŸ°' },
                { id: 2, x: '45%', y: '25%', title: 'í‰ì–‘ì„±', content: 'ê·¼ì´ˆê³ ì™•ì´ ê³µê²©í•œ ê³ êµ¬ë ¤ ìš”ì¶©ì§€.', icon: 'ğŸ¹' },
                { id: 3, x: '35%', y: '55%', title: 'ìš”ì„œ ì§€ì—­', content: 'ë°±ì œì˜ í•´ì™¸ ì§„ì¶œì§€.', icon: 'ğŸš¢' }
            ],
            'goguryeo': [
                { id: 4, x: '45%', y: '25%', title: 'í‰ì–‘ì„±', content: 'ì¥ìˆ˜ì™•ì´ ì²œë„í•œ ê³³.', icon: 'ğŸ¢' },
                { id: 5, x: '42%', y: '45%', title: 'í•œì„±(ì„œìš¸)', content: 'ê³ êµ¬ë ¤ê°€ ì ë ¹í•œ í•œê°• ìœ ì—­.', icon: 'âš”ï¸' }
            ],
            'silla': [
                { id: 7, x: '42%', y: '45%', title: 'í•œê°• ìœ ì—­', content: 'ì‹ ë¼ ì „ì„±ê¸°ì˜ ìƒì§•.', icon: 'ğŸŒŠ' },
                { id: 8, x: '65%', y: '65%', title: 'ê¸ˆì„±(ê²½ì£¼)', content: 'ì‹ ë¼ì˜ ìˆ˜ë„.', icon: 'ğŸŒ¸' }
            ]
        };

        const missions = [
            { id: 1, era: 'baekje', question: "4ì„¸ê¸° ë°±ì œì˜ ì „ì„±ê¸° ì™•ì€?", answer: "ê·¼ì´ˆê³ ì™•", hint: "ê·¼Xê³ ì™•" },
            { id: 2, era: 'goguryeo', question: "5ì„¸ê¸° ê³ êµ¬ë ¤ ì¥ìˆ˜ì™•ì´ ì²œë„í•œ ê³³ì€?", answer: "í‰ì–‘", hint: "ã…ã…‡" },
            { id: 3, era: 'silla', question: "6ì„¸ê¸° í•œê°• ìœ ì—­ ë¹„ì„ì€?", answer: "ì§„í¥ì™• ìˆœìˆ˜ë¹„", hint: "ã…ˆã…ã…‡ ã……ã……ã…‚" },
            { id: 4, era: 'common', question: "ì‚¼êµ­ ê³µí†µ ìš”ì¶©ì§€ëŠ”?", answer: "í•œê°•", hint: "ã…ã„±" }
        ];

        window.onload = () => { renderMissions(); changeEra('baekje'); };

        function startLearning() {
            studentInfo.classNum = document.getElementById('classNum').value;
            studentInfo.studentId = document.getElementById('studentId').value;
            studentInfo.studentName = document.getElementById('studentName').value;
            if(!studentInfo.classNum || !studentInfo.studentId || !studentInfo.studentName) return alert('ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            document.getElementById('startScreen').classList.add('hidden');
        }

        function changeEra(era) {
            currentEra = era;
            document.querySelectorAll('.era-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.btn-${era}`).classList.add('active');
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.style.backgroundImage = `url('https://gtmc-history.github.io/three-kingdoms-map/map_${era}.png')`;
            mapContainer.querySelectorAll('.map-point').forEach(p => p.remove());
            pointsData[era]?.forEach(point => {
                const el = document.createElement('div');
                el.className = 'map-point';
                el.style.left = point.x; el.style.top = point.y;
                el.onclick = () => showInfo(era, point.id);
                mapContainer.appendChild(el);
            });
        }

        function renderMissions() {
            const section = document.getElementById('missionSection');
            section.innerHTML = '';
            missions.forEach(m => {
                const isSolved = solvedMissions[m.id];
                const card = document.createElement('div');
                card.className = `mission-card ${isSolved ? 'completed' : ''}`;
                card.innerHTML = `
                    <div class="mission-header"><span class="mission-title">ë¯¸ì…˜ #${m.id}</span></div>
                    <p>${m.question}</p>
                    <div class="mission-input-group">
                        <input type="text" class="mission-input" id="input-${m.id}" placeholder="ì •ë‹µ ì…ë ¥" ${isSolved ? 'disabled value="'+isSolved.answer+'"' : ''}>
                        <button class="check-btn" onclick="checkAnswer(${m.id})">í™•ì¸</button>
                    </div>
                    <button class="hint-btn" onclick="useHint('${m.hint}')">ğŸ’¡ íŒíŠ¸ ë³´ê¸°</button>
                `;
                section.appendChild(card);
            });
        }

        function useHint(h) {
            hintCount++;
            alert(`íŒíŠ¸: ${h}`);
        }

        function checkAnswer(id) {
            const input = document.getElementById(`input-${id}`);
            const mission = missions.find(m => m.id === id);
            if (input.value.trim() === mission.answer) {
                alert('ì •ë‹µì…ë‹ˆë‹¤!');
                solvedMissions[id] = { missionNum: id, answer: input.value };
                renderMissions();
            } else alert('ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”.');
        }

        function showInfo(era, pointId) {
            const point = pointsData[era].find(p => p.id === pointId);
            document.getElementById('modalTitle').innerText = point.title;
            document.getElementById('modalBody').innerText = point.content;
            document.getElementById('modal').classList.add('visible');
        }

        function closeModal(e) { if (!e || e.target.id === 'modal' || e.target.className === 'close-modal') document.getElementById('modal').classList.remove('visible'); }

        function showSummary() {
            let count = Object.keys(solvedMissions).length;
            alert(`${studentInfo.studentName} í•™ìƒ, ${count}ê°œ ë¯¸ì…˜ ì™„ë£Œ!`);
        }

        // ===== ë°ì´í„° ì „ì†¡ (ìš”ì²­í•˜ì‹  ì‹œíŠ¸ êµ¬ì¡° ìˆœì„œ ë§¤ì¹­) =====
        function submitAllData() {
            if (Object.keys(solvedMissions).length === 0) return alert('ë¯¸ì…˜ì„ ë¨¼ì € í’€ì–´ì£¼ì„¸ìš”.');
            if (!confirm('í•™ìŠµ ë°ì´í„°ë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const missionIds = Object.keys(solvedMissions).join(', ');
            const answers = Object.values(solvedMissions).map(m => `[${m.missionNum}]${m.answer}`).join(' | ');

            const payload = {
                classNum: studentInfo.classNum,      // ë°˜
                studentId: studentInfo.studentId,    // í•™ë²ˆ
                studentName: studentInfo.studentName,// ì´ë¦„
                missionNum: missionIds,              // ë¯¸ì…˜ë²ˆí˜¸
                answer: answers,                     // í•™ìƒë‹µë³€
                isCorrect: "O",                      // ì •ë‹µì—¬ë¶€
                hintsUsed: hintCount,                // íŒíŠ¸ì‚¬ìš©
                timeSpent: 0                         // ì†Œìš”ì‹œê°„
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => alert('êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì œì¶œì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!'))
            .catch(err => alert('ì „ì†¡ ì‹¤íŒ¨: ' + err));
        }
    </script>
</body>
</html>